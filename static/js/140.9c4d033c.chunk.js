"use strict";(self.webpackChunkbabylonjs_check=self.webpackChunkbabylonjs_check||[]).push([[140],{4140:(e,t,s)=>{s.r(t),s.d(t,{_BasisTextureLoader:()=>F});var a,r=s(543),o=s(5415),n=s(8665),i=s(7559);function c(){const e=0,t=1,s=2,a=3,r=6,o=8,n=9,i=10,c=14;let l=null;function d(e,t,s,a,r){const o=e.getImageTranscodedSizeInBytes(t,s,a);let n=new Uint8Array(o);if(!e.transcodeImage(n,t,s,a,1,0))return null;if(r){n=function(e,t,s,a){const r=new Uint16Array(4),o=new Uint16Array(s*a),n=s/4,i=a/4;for(let c=0;c<i;c++)for(let a=0;a<n;a++){const i=t+8*(c*n+a);r[0]=e[i]|e[i+1]<<8,r[1]=e[i+2]|e[i+3]<<8,r[2]=(2*(31&r[0])+1*(31&r[1]))/3|(2*(2016&r[0])+1*(2016&r[1]))/3&2016|(2*(63488&r[0])+1*(63488&r[1]))/3&63488,r[3]=(2*(31&r[1])+1*(31&r[0]))/3|(2*(2016&r[1])+1*(2016&r[0]))/3&2016|(2*(63488&r[1])+1*(63488&r[0]))/3&63488;for(let t=0;t<4;t++){const n=e[i+4+t];let l=(4*c+t)*s+4*a;o[l++]=r[3&n],o[l++]=r[n>>2&3],o[l++]=r[n>>4&3],o[l++]=r[n>>6&3]}}return o}(n,0,e.getImageWidth(t,s)+3&-4,e.getImageHeight(t,s)+3&-4)}return n}onmessage=u=>{if("init"===u.data.action){if(u.data.url)try{importScripts(u.data.url)}catch(T){postMessage({action:"error",error:T})}l||(l=BASIS({wasmBinary:u.data.wasmBinary})),null!==l&&l.then((e=>{BASIS=e,e.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===u.data.action){const l=u.data.config,T=u.data.imageData,p=new BASIS.BasisFile(T),g=function(e){const t=e.getHasAlpha(),s=e.getNumImages(),a=[];for(let r=0;r<s;r++){const t={levels:[]},s=e.getNumLevels(r);for(let a=0;a<s;a++){const s={width:e.getImageWidth(r,a),height:e.getImageHeight(r,a)};t.levels.push(s)}a.push(t)}return{hasAlpha:t,images:a}}(p);let f=u.data.ignoreSupportedFormats?null:function(l,d){let u=null;l.supportedCompressionFormats&&(u=l.supportedCompressionFormats.astc?i:l.supportedCompressionFormats.bc7?r:l.supportedCompressionFormats.s3tc?d.hasAlpha?a:s:l.supportedCompressionFormats.pvrtc?d.hasAlpha?n:o:l.supportedCompressionFormats.etc2?t:l.supportedCompressionFormats.etc1?e:c);return u}(u.data.config,g),m=!1;null===f&&(m=!0,f=g.hasAlpha?a:s);let h=!0;p.startTranscoding()||(h=!1);const F=[];for(let e=0;e<g.images.length&&h;e++){const t=g.images[e];if(void 0===l.loadSingleImage||l.loadSingleImage===e){let s=t.levels.length;!1===l.loadMipmapLevels&&(s=1);for(let a=0;a<s;a++){const s=t.levels[a],r=d(p,e,a,f,m);if(!r){h=!1;break}s.transcodedPixels=r,F.push(s.transcodedPixels.buffer)}}}p.close(),p.delete(),m&&(f=-1),h?postMessage({action:"transcode",success:h,id:u.data.id,fileInfo:g,format:f},F):postMessage({action:"transcode",success:h,id:u.data.id})}}}!function(e){e[e.cTFETC1=0]="cTFETC1",e[e.cTFETC2=1]="cTFETC2",e[e.cTFBC1=2]="cTFBC1",e[e.cTFBC3=3]="cTFBC3",e[e.cTFBC4=4]="cTFBC4",e[e.cTFBC5=5]="cTFBC5",e[e.cTFBC7=6]="cTFBC7",e[e.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",e[e.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",e[e.cTFASTC_4x4=10]="cTFASTC_4x4",e[e.cTFATC_RGB=11]="cTFATC_RGB",e[e.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e.cTFRGBA32=13]="cTFRGBA32",e[e.cTFRGB565=14]="cTFRGB565",e[e.cTFBGR565=15]="cTFBGR565",e[e.cTFRGBA4444=16]="cTFRGBA4444",e[e.cTFFXT1_RGB=17]="cTFFXT1_RGB",e[e.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",e[e.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",e[e.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",e[e.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"}(a||(a={}));const l={JSModuleURL:`${r.S0._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${r.S0._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`};let d=null,u=null,T=0;const p=()=>(d||(d=new Promise(((e,t)=>{u?e(u):r.S0.LoadFileAsync(r.S0.GetBabylonScriptURL(l.WasmModuleURL)).then((s=>{if("function"!==typeof URL)return t("Basis transcoder requires an environment with a URL constructor");const a=URL.createObjectURL(new Blob([`(${c})()`],{type:"application/javascript"}));u=new Worker(a),function(e,t,s){return new Promise(((a,o)=>{const n=t=>{"init"===t.data.action?(e.removeEventListener("message",n),a(e)):"error"===t.data.action&&o(t.data.error||"error initializing worker")};e.addEventListener("message",n),e.postMessage({action:"init",url:s?r.S0.GetBabylonScriptURL(s):void 0,wasmBinary:t},[t])}))}(u,s,l.JSModuleURL).then(e,t)})).catch(t)}))),d),g=(e,t)=>{const s=e instanceof ArrayBuffer?new Uint8Array(e):e;return new Promise(((e,a)=>{p().then((()=>{const r=T++,o=t=>{"transcode"===t.data.action&&t.data.id===r&&(u.removeEventListener("message",o),t.data.success?e(t.data):a("Transcode is not supported on this device"))};u.addEventListener("message",o);const n=new Uint8Array(s.byteLength);n.set(new Uint8Array(s.buffer,s.byteOffset,s.byteLength)),u.postMessage({action:"transcode",id:r,imageData:n,config:t,ignoreSupportedFormats:false},[n.buffer])}),(e=>{a(e)}))}))},f=(e,t)=>{let s=t._gl?.TEXTURE_2D;e.isCube&&(s=t._gl?.TEXTURE_CUBE_MAP),t._bindTextureDirectly(s,e,!0)},m=(e,t)=>{const s=e.getEngine();for(let c=0;c<t.fileInfo.images.length;c++){const l=t.fileInfo.images[c].levels[0];if(e._invertVScale=e.invertY,-1===t.format||t.format===a.cTFRGB565)if(e.type=10,e.format=4,!s._features.basisNeedsPOT||i.X.Log2(l.width)%1===0&&i.X.Log2(l.height)%1===0)e._invertVScale=!e.invertY,e.width=l.width+3&-4,e.height=l.height+3&-4,e.samplingMode=2,f(e,s),s._uploadDataToTextureDirectly(e,new Uint16Array(l.transcodedPixels.buffer),c,0,4,!0);else{const t=new n.h(s,2);e._invertVScale=e.invertY,t.type=10,t.format=4,t.width=l.width+3&-4,t.height=l.height+3&-4,f(t,s),s._uploadDataToTextureDirectly(t,new Uint16Array(l.transcodedPixels.buffer),c,0,4,!0),s._rescaleTexture(t,e,s.scenes[0],s._getInternalFormat(4),(()=>{s._releaseTexture(t),f(e,s)}))}else{e.width=l.width,e.height=l.height,e.generateMipMaps=t.fileInfo.images[c].levels.length>1;const a=h.GetInternalFormatFromBasisFormat(t.format,s);e.format=a,f(e,s),t.fileInfo.images[c].levels.forEach(((t,r)=>{s._uploadCompressedDataToTextureDirectly(e,a,t.width,t.height,t.transcodedPixels,c,r)})),!s._features.basisNeedsPOT||i.X.Log2(e.width)%1===0&&i.X.Log2(e.height)%1===0||(r.S0.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),e._cachedWrapU=o.g.CLAMP_ADDRESSMODE,e._cachedWrapV=o.g.CLAMP_ADDRESSMODE)}}},h={JSModuleURL:l.JSModuleURL,WasmModuleURL:l.WasmModuleURL,GetInternalFormatFromBasisFormat:(e,t)=>{let s;switch(e){case a.cTFETC1:s=36196;break;case a.cTFBC1:s=33776;break;case a.cTFBC4:s=33779;break;case a.cTFASTC_4x4:s=37808;break;case a.cTFETC2:s=37496;break;case a.cTFBC7:s=36492}if(void 0===s)throw"The chosen Basis transcoder format is not currently supported";return s},TranscodeAsync:g,LoadTextureFromTranscodeResult:m};Object.defineProperty(h,"JSModuleURL",{get:function(){return l.JSModuleURL},set:function(e){l.JSModuleURL=e}}),Object.defineProperty(h,"WasmModuleURL",{get:function(){return l.WasmModuleURL},set:function(e){l.WasmModuleURL=e}});s(6952);class F{constructor(){this.supportCascades=!1}loadCubeData(e,t,s,a,o){if(Array.isArray(e))return;const n=t.getEngine().getCaps(),i={supportedCompressionFormats:{etc1:!!n.etc1,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2,astc:!!n.astc,bc7:!!n.bptc}};g(e,i).then((e=>{const s=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;m(t,e),t.getEngine()._setCubeMapTextureParams(t,s),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),a&&a()})).catch((e=>{r.S0.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.isReady=!0,o&&o(e)}))}loadData(e,t,s){const a=t.getEngine().getCaps(),o={supportedCompressionFormats:{etc1:!!a.etc1,s3tc:!!a.s3tc,pvrtc:!!a.pvrtc,etc2:!!a.etc2,astc:!!a.astc,bc7:!!a.bptc}};g(e,o).then((e=>{const a=e.fileInfo.images[0].levels[0],r=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;s(a.width,a.height,r,-1!==e.format,(()=>{m(t,e)}))})).catch((e=>{r.S0.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),r.S0.Warn(`Failed to transcode Basis file: ${e}`),s(0,0,!1,!1,(()=>{}),!0)}))}}}}]);
//# sourceMappingURL=140.9c4d033c.chunk.js.map